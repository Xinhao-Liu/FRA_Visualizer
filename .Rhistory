mutate(Date = as.Date(as.character(Date),format = "%Y%m%d")) %>%
filter(TrainType %in% c("F"),
Accident_type %in% c("Derailments","Collisions"),
#`class 1`=="class1",
`Railroad Successor` %in% c("BNSF","KCS","UP","CSX","NS","CNGT","CP(US)"),
ACCTRK %in% c(1,3),
Date <= "2022-12-31",
Date >= "2013-01-01") %>%
mutate(`Railroad Successor` = ifelse(`Railroad Successor` == "CNGT", "CN",
ifelse(`Railroad Successor` == "CP(US)", "CP", `Railroad Successor`))) %>%
mutate(traffic_name = paste(ifelse(`class 1`=="class1", `Railroad Successor`, "Non"),
"ClassI",
"Freight",
ifelse(ACCTRK%in%c(1,3),"Both_Mainline","Non_Mainline"),sep = "_")) %>%
select(`Railroad Successor`,`class 1`,ACCTRK,Accident_type,Category,traffic_name,Year) %>%
left_join(raw_traffic,by=c("traffic_name"="...1")) %>%
mutate(index = Year - 1996 + 8, traffic_value = 0)
num_vec = seq(1:nrow(aaa))
index_vec = as.vector(aaa %>% select(index))[[1]]
final = aaa
traffic_val = mapply(function(i, j) {
final[i, ncol(aaa)] = aaa[i, j][[1]]
}, i = num_vec, j = index_vec)
final =
final %>%
mutate(traffic_value = traffic_val) %>%
mutate(ACCTRK = as.factor(ACCTRK)) %>%
select(Category,traffic_value,Year) %>%
group_by(Category,Year) %>%
mutate(count=n(),final_traffic = sum(unique(traffic_value))) %>%
mutate(final_traffic = max(final_traffic)) %>%
ungroup() %>%
group_by(Year) %>%
mutate(rate=count/final_traffic) %>%
unique()
aaa = raw %>%
# filter(!is.na(TYPE_clean), !is.na(TotalDerail), TotalDerail >= 0) %>%
mutate(Accident_type = ifelse(TYPE_clean == "01", "Derailments",
ifelse(TYPE_clean %in% c("02","03","04","05","06","08"), "Collisions",
ifelse(TYPE_clean == "07", "Grade Crossing", "Other")))) %>%
mutate(Date = as.Date(as.character(Date),format = "%Y%m%d")) %>%
filter(TrainType %in% c("F"),
Accident_type %in% c("Derailments","Collisions"),
#`class 1`=="class1",
`Railroad Successor` %in% c("BNSF","KCS","UP","CSX","NS","CNGT","CP(US)"),
ACCTRK %in% c(1,3),
Date <= "2022-12-31",
Date >= "2013-01-01") %>%
mutate(`Railroad Successor` = ifelse(`Railroad Successor` == "CNGT", "CN",
ifelse(`Railroad Successor` == "CP(US)", "CP", `Railroad Successor`))) %>%
mutate(traffic_name = paste(ifelse(`class 1`=="class1", `Railroad Successor`, "Non"),
"ClassI",
"Freight",
ifelse(ACCTRK%in%c(1,3),"Both_Mainline","Non_Mainline"),sep = "_")) %>%
select(`Railroad Successor`,`class 1`,ACCTRK,Accident_type,Category,traffic_name,Year) %>%
left_join(raw_traffic,by=c("traffic_name"="...1")) %>%
mutate(index = Year - 1996 + 8, traffic_value = 0)
num_vec = seq(1:nrow(aaa))
index_vec = as.vector(aaa %>% select(index))[[1]]
final = aaa
traffic_val = mapply(function(i, j) {
final[i, ncol(aaa)] = aaa[i, j][[1]]
}, i = num_vec, j = index_vec)
final =
final %>%
mutate(traffic_value = traffic_val) %>%
mutate(ACCTRK = as.factor(ACCTRK)) %>%
select(Category,traffic_value,Year) %>%
group_by(Category,Year) %>%
mutate(count=n(),final_traffic = sum(unique(traffic_value))) %>%
ungroup() %>%
group_by(Year) %>%
mutate(rate=count/final_traffic) %>%
mutate(final_traffic = max(final_traffic)) %>%
unique()
aaa = raw %>%
# filter(!is.na(TYPE_clean), !is.na(TotalDerail), TotalDerail >= 0) %>%
mutate(Accident_type = ifelse(TYPE_clean == "01", "Derailments",
ifelse(TYPE_clean %in% c("02","03","04","05","06","08"), "Collisions",
ifelse(TYPE_clean == "07", "Grade Crossing", "Other")))) %>%
mutate(Date = as.Date(as.character(Date),format = "%Y%m%d")) %>%
filter(TrainType %in% c("F"),
Accident_type %in% c("Derailments","Collisions"),
#`class 1`=="class1",
`Railroad Successor` %in% c("BNSF","KCS","UP","CSX","NS","CNGT","CP(US)"),
ACCTRK %in% c(1,3),
Date <= "2022-12-31",
Date >= "2013-01-01") %>%
mutate(`Railroad Successor` = ifelse(`Railroad Successor` == "CNGT", "CN",
ifelse(`Railroad Successor` == "CP(US)", "CP", `Railroad Successor`))) %>%
mutate(traffic_name = paste(ifelse(`class 1`=="class1", `Railroad Successor`, "Non"),
"ClassI",
"Freight",
ifelse(ACCTRK%in%c(1,3),"Both_Mainline","Non_Mainline"),sep = "_")) %>%
select(`Railroad Successor`,`class 1`,ACCTRK,Accident_type,Category,traffic_name,Year) %>%
left_join(raw_traffic,by=c("traffic_name"="...1")) %>%
mutate(index = Year - 1996 + 8, traffic_value = 0)
num_vec = seq(1:nrow(aaa))
index_vec = as.vector(aaa %>% select(index))[[1]]
final = aaa
traffic_val = mapply(function(i, j) {
final[i, ncol(aaa)] = aaa[i, j][[1]]
}, i = num_vec, j = index_vec)
final =
final %>%
mutate(traffic_value = traffic_val) %>%
mutate(ACCTRK = as.factor(ACCTRK)) %>%
select(Category,traffic_value,Year) %>%
group_by(Category,Year) %>%
mutate(count=n(),final_traffic = sum(unique(traffic_value))) %>%
ungroup() %>%
group_by(Year) %>%
mutate(rate=count/final_traffic) %>%
mutate(final_traffic = max(final_traffic)) %>%
unique() %>%
select(Accident_type,Year,rate) %>%
unique()
aaa = raw %>%
# filter(!is.na(TYPE_clean), !is.na(TotalDerail), TotalDerail >= 0) %>%
mutate(Accident_type = ifelse(TYPE_clean == "01", "Derailments",
ifelse(TYPE_clean %in% c("02","03","04","05","06","08"), "Collisions",
ifelse(TYPE_clean == "07", "Grade Crossing", "Other")))) %>%
mutate(Date = as.Date(as.character(Date),format = "%Y%m%d")) %>%
filter(TrainType %in% c("F"),
Accident_type %in% c("Derailments","Collisions"),
#`class 1`=="class1",
`Railroad Successor` %in% c("BNSF","KCS","UP","CSX","NS","CNGT","CP(US)"),
ACCTRK %in% c(1,3),
Date <= "2022-12-31",
Date >= "2013-01-01") %>%
mutate(`Railroad Successor` = ifelse(`Railroad Successor` == "CNGT", "CN",
ifelse(`Railroad Successor` == "CP(US)", "CP", `Railroad Successor`))) %>%
mutate(traffic_name = paste(ifelse(`class 1`=="class1", `Railroad Successor`, "Non"),
"ClassI",
"Freight",
ifelse(ACCTRK%in%c(1,3),"Both_Mainline","Non_Mainline"),sep = "_")) %>%
select(`Railroad Successor`,`class 1`,ACCTRK,Accident_type,Category,traffic_name,Year) %>%
left_join(raw_traffic,by=c("traffic_name"="...1")) %>%
mutate(index = Year - 1996 + 8, traffic_value = 0)
num_vec = seq(1:nrow(aaa))
index_vec = as.vector(aaa %>% select(index))[[1]]
final = aaa
traffic_val = mapply(function(i, j) {
final[i, ncol(aaa)] = aaa[i, j][[1]]
}, i = num_vec, j = index_vec)
final =
final %>%
mutate(traffic_value = traffic_val) %>%
mutate(ACCTRK = as.factor(ACCTRK)) %>%
select(`Railroad Successor`,`class 1`,ACCTRK,Accident_type,Category,traffic_name,Year) %>%
group_by(Category,Year) %>%
mutate(count=n(),final_traffic = sum(unique(traffic_value))) %>%
ungroup() %>%
group_by(Year) %>%
mutate(rate=count/final_traffic) %>%
mutate(final_traffic = max(final_traffic)) %>%
unique() %>%
select(Accident_type,Year,rate) %>%
unique()
aaa = raw %>%
# filter(!is.na(TYPE_clean), !is.na(TotalDerail), TotalDerail >= 0) %>%
mutate(Accident_type = ifelse(TYPE_clean == "01", "Derailments",
ifelse(TYPE_clean %in% c("02","03","04","05","06","08"), "Collisions",
ifelse(TYPE_clean == "07", "Grade Crossing", "Other")))) %>%
mutate(Date = as.Date(as.character(Date),format = "%Y%m%d")) %>%
filter(TrainType %in% c("F"),
Accident_type %in% c("Derailments","Collisions"),
#`class 1`=="class1",
`Railroad Successor` %in% c("BNSF","KCS","UP","CSX","NS","CNGT","CP(US)"),
ACCTRK %in% c(1,3),
Date <= "2022-12-31",
Date >= "2013-01-01") %>%
mutate(`Railroad Successor` = ifelse(`Railroad Successor` == "CNGT", "CN",
ifelse(`Railroad Successor` == "CP(US)", "CP", `Railroad Successor`))) %>%
mutate(traffic_name = paste(ifelse(`class 1`=="class1", `Railroad Successor`, "Non"),
"ClassI",
"Freight",
ifelse(ACCTRK%in%c(1,3),"Both_Mainline","Non_Mainline"),sep = "_")) %>%
select(`Railroad Successor`,`class 1`,ACCTRK,Accident_type,Category,traffic_name,Year) %>%
left_join(raw_traffic,by=c("traffic_name"="...1")) %>%
mutate(index = Year - 1996 + 8, traffic_value = 0)
num_vec = seq(1:nrow(aaa))
index_vec = as.vector(aaa %>% select(index))[[1]]
final = aaa
traffic_val = mapply(function(i, j) {
final[i, ncol(aaa)] = aaa[i, j][[1]]
}, i = num_vec, j = index_vec)
final =
final %>%
mutate(traffic_value = traffic_val) %>%
mutate(ACCTRK = as.factor(ACCTRK)) %>%
select(`Railroad Successor`,`class 1`,ACCTRK,Accident_type,Category,traffic_name,Year) %>%
group_by(Category,Year) %>%
mutate(count=n(),final_traffic = sum(unique(traffic_value))) %>%
ungroup() %>%
group_by(Year) %>%
mutate(final_traffic = max(final_traffic)) %>%
mutate(rate=count/final_traffic) %>%
unique() %>%
select(Accident_type,Year,rate) %>%
unique()
aaa = raw %>%
# filter(!is.na(TYPE_clean), !is.na(TotalDerail), TotalDerail >= 0) %>%
mutate(Accident_type = ifelse(TYPE_clean == "01", "Derailments",
ifelse(TYPE_clean %in% c("02","03","04","05","06","08"), "Collisions",
ifelse(TYPE_clean == "07", "Grade Crossing", "Other")))) %>%
mutate(Date = as.Date(as.character(Date),format = "%Y%m%d")) %>%
filter(TrainType %in% c("F"),
Accident_type %in% c("Derailments","Collisions"),
#`class 1`=="class1",
`Railroad Successor` %in% c("BNSF","KCS","UP","CSX","NS","CNGT","CP(US)"),
ACCTRK %in% c(1,3),
Date <= "2022-12-31",
Date >= "2013-01-01") %>%
mutate(`Railroad Successor` = ifelse(`Railroad Successor` == "CNGT", "CN",
ifelse(`Railroad Successor` == "CP(US)", "CP", `Railroad Successor`))) %>%
mutate(traffic_name = paste(ifelse(`class 1`=="class1", `Railroad Successor`, "Non"),
"ClassI",
"Freight",
ifelse(ACCTRK%in%c(1,3),"Both_Mainline","Non_Mainline"),sep = "_")) %>%
select(`Railroad Successor`,`class 1`,ACCTRK,Accident_type,Category,traffic_name,Year) %>%
left_join(raw_traffic,by=c("traffic_name"="...1")) %>%
mutate(index = Year - 1996 + 8, traffic_value = 0)
num_vec = seq(1:nrow(aaa))
index_vec = as.vector(aaa %>% select(index))[[1]]
final = aaa
traffic_val = mapply(function(i, j) {
final[i, ncol(aaa)] = aaa[i, j][[1]]
}, i = num_vec, j = index_vec)
final =
final %>%
mutate(traffic_value = traffic_val) %>%
mutate(ACCTRK = as.factor(ACCTRK)) %>%
select(`Railroad Successor`,`class 1`,ACCTRK,Accident_type,Category,traffic_value,Year) %>%
group_by(Category,Year) %>%
mutate(count=n(),final_traffic = sum(unique(traffic_value))) %>%
ungroup() %>%
group_by(Year) %>%
mutate(final_traffic = max(final_traffic)) %>%
mutate(rate=count/final_traffic) %>%
unique() %>%
select(Accident_type,Year,rate) %>%
unique()
aaa = raw %>%
# filter(!is.na(TYPE_clean), !is.na(TotalDerail), TotalDerail >= 0) %>%
mutate(Accident_type = ifelse(TYPE_clean == "01", "Derailments",
ifelse(TYPE_clean %in% c("02","03","04","05","06","08"), "Collisions",
ifelse(TYPE_clean == "07", "Grade Crossing", "Other")))) %>%
mutate(Date = as.Date(as.character(Date),format = "%Y%m%d")) %>%
filter(TrainType %in% c("F"),
Accident_type %in% c("Derailments","Collisions"),
#`class 1`=="class1",
`Railroad Successor` %in% c("BNSF","KCS","UP","CSX","NS","CNGT","CP(US)"),
ACCTRK %in% c(1,3),
Date <= "2022-12-31",
Date >= "2013-01-01") %>%
mutate(`Railroad Successor` = ifelse(`Railroad Successor` == "CNGT", "CN",
ifelse(`Railroad Successor` == "CP(US)", "CP", `Railroad Successor`))) %>%
mutate(traffic_name = paste(ifelse(`class 1`=="class1", `Railroad Successor`, "Non"),
"ClassI",
"Freight",
ifelse(ACCTRK%in%c(1,3),"Both_Mainline","Non_Mainline"),sep = "_")) %>%
select(`Railroad Successor`,`class 1`,ACCTRK,Accident_type,Category,traffic_name,Year) %>%
left_join(raw_traffic,by=c("traffic_name"="...1")) %>%
mutate(index = Year - 1996 + 8, traffic_value = 0)
num_vec = seq(1:nrow(aaa))
index_vec = as.vector(aaa %>% select(index))[[1]]
final = aaa
traffic_val = mapply(function(i, j) {
final[i, ncol(aaa)] = aaa[i, j][[1]]
}, i = num_vec, j = index_vec)
final =
final %>%
mutate(traffic_value = traffic_val) %>%
mutate(ACCTRK = as.factor(ACCTRK)) %>%
select(`Railroad Successor`,`class 1`,ACCTRK,Accident_type,Category,traffic_value,Year) %>%
group_by(Category,Year) %>%
mutate(count=n(),final_traffic = sum(unique(traffic_value))) %>%
ungroup() %>%
group_by(Year) %>%
mutate(final_traffic = max(final_traffic)) %>%
mutate(rate=count/final_traffic) %>%
unique()
aaa = raw %>%
# filter(!is.na(TYPE_clean), !is.na(TotalDerail), TotalDerail >= 0) %>%
mutate(Accident_type = ifelse(TYPE_clean == "01", "Derailments",
ifelse(TYPE_clean %in% c("02","03","04","05","06","08"), "Collisions",
ifelse(TYPE_clean == "07", "Grade Crossing", "Other")))) %>%
mutate(Date = as.Date(as.character(Date),format = "%Y%m%d")) %>%
filter(TrainType %in% c("F"),
Accident_type %in% c("Derailments","Collisions"),
#`class 1`=="class1",
#`Railroad Successor` %in% c("BNSF","KCS","UP","CSX","NS","CNGT","CP(US)"),
ACCTRK %in% c(1,3),
Date <= "2022-12-31",
Date >= "2013-01-01") %>%
mutate(`Railroad Successor` = ifelse(`Railroad Successor` == "CNGT", "CN",
ifelse(`Railroad Successor` == "CP(US)", "CP", `Railroad Successor`))) %>%
mutate(traffic_name = paste(ifelse(`class 1`=="class1", `Railroad Successor`, "Non"),
"ClassI",
"Freight",
ifelse(ACCTRK%in%c(1,3),"Both_Mainline","Non_Mainline"),sep = "_")) %>%
select(`Railroad Successor`,`class 1`,ACCTRK,Accident_type,Category,traffic_name,Year) %>%
left_join(raw_traffic,by=c("traffic_name"="...1")) %>%
mutate(index = Year - 1996 + 8, traffic_value = 0)
num_vec = seq(1:nrow(aaa))
index_vec = as.vector(aaa %>% select(index))[[1]]
final = aaa
traffic_val = mapply(function(i, j) {
final[i, ncol(aaa)] = aaa[i, j][[1]]
}, i = num_vec, j = index_vec)
final =
final %>%
mutate(traffic_value = traffic_val) %>%
mutate(ACCTRK = as.factor(ACCTRK)) %>%
select(`Railroad Successor`,`class 1`,ACCTRK,Accident_type,Category,traffic_value,Year) %>%
group_by(Category,Year) %>%
mutate(count=n(),final_traffic = sum(unique(traffic_value))) %>%
ungroup() %>%
group_by(Year) %>%
mutate(final_traffic = max(final_traffic)) %>%
mutate(rate=count/final_traffic) %>%
unique()
aaa = raw %>%
# filter(!is.na(TYPE_clean), !is.na(TotalDerail), TotalDerail >= 0) %>%
mutate(Accident_type = ifelse(TYPE_clean == "01", "Derailments",
ifelse(TYPE_clean %in% c("02","03","04","05","06","08"), "Collisions",
ifelse(TYPE_clean == "07", "Grade Crossing", "Other")))) %>%
mutate(Date = as.Date(as.character(Date),format = "%Y%m%d")) %>%
filter(TrainType %in% c("F"),
Accident_type %in% c("Derailments","Collisions"),
`class 1`=="class1",
#`Railroad Successor` %in% c("BNSF","KCS","UP","CSX","NS","CNGT","CP(US)"),
ACCTRK %in% c(1,3),
Date <= "2022-12-31",
Date >= "2013-01-01") %>%
mutate(`Railroad Successor` = ifelse(`Railroad Successor` == "CNGT", "CN",
ifelse(`Railroad Successor` == "CP(US)", "CP", `Railroad Successor`))) %>%
mutate(traffic_name = paste(ifelse(`class 1`=="class1", `Railroad Successor`, "Non"),
"ClassI",
"Freight",
ifelse(ACCTRK%in%c(1,3),"Both_Mainline","Non_Mainline"),sep = "_")) %>%
select(`Railroad Successor`,`class 1`,ACCTRK,Accident_type,Category,traffic_name,Year) %>%
left_join(raw_traffic,by=c("traffic_name"="...1")) %>%
mutate(index = Year - 1996 + 8, traffic_value = 0)
num_vec = seq(1:nrow(aaa))
index_vec = as.vector(aaa %>% select(index))[[1]]
final = aaa
traffic_val = mapply(function(i, j) {
final[i, ncol(aaa)] = aaa[i, j][[1]]
}, i = num_vec, j = index_vec)
final =
final %>%
mutate(traffic_value = traffic_val) %>%
mutate(ACCTRK = as.factor(ACCTRK)) %>%
select(`Railroad Successor`,`class 1`,ACCTRK,Accident_type,Category,traffic_value,Year) %>%
group_by(Category,Year) %>%
mutate(count=n(),final_traffic = sum(unique(traffic_value))) %>%
ungroup() %>%
group_by(Year) %>%
mutate(final_traffic = max(final_traffic)) %>%
mutate(rate=count/final_traffic) %>%
unique()
aaa = raw %>%
# filter(!is.na(TYPE_clean), !is.na(TotalDerail), TotalDerail >= 0) %>%
mutate(Accident_type = ifelse(TYPE_clean == "01", "Derailments",
ifelse(TYPE_clean %in% c("02","03","04","05","06","08"), "Collisions",
ifelse(TYPE_clean == "07", "Grade Crossing", "Other")))) %>%
mutate(Date = as.Date(as.character(Date),format = "%Y%m%d")) %>%
filter(TrainType %in% c("F"),
Accident_type %in% c("Derailments","Collisions"),
`class 1`=="class1",
#`Railroad Successor` %in% c("BNSF","KCS","UP","CSX","NS","CNGT","CP(US)"),
ACCTRK %in% c(2,4),
Date <= "2022-12-31",
Date >= "2013-01-01") %>%
mutate(`Railroad Successor` = ifelse(`Railroad Successor` == "CNGT", "CN",
ifelse(`Railroad Successor` == "CP(US)", "CP", `Railroad Successor`))) %>%
mutate(traffic_name = paste(ifelse(`class 1`=="class1", `Railroad Successor`, "Non"),
"ClassI",
"Freight",
ifelse(ACCTRK%in%c(1,3),"Both_Mainline","Non_Mainline"),sep = "_")) %>%
select(`Railroad Successor`,`class 1`,ACCTRK,Accident_type,Category,traffic_name,Year) %>%
left_join(raw_traffic,by=c("traffic_name"="...1")) %>%
mutate(index = Year - 1996 + 8, traffic_value = 0)
num_vec = seq(1:nrow(aaa))
index_vec = as.vector(aaa %>% select(index))[[1]]
final = aaa
traffic_val = mapply(function(i, j) {
final[i, ncol(aaa)] = aaa[i, j][[1]]
}, i = num_vec, j = index_vec)
final =
final %>%
mutate(traffic_value = traffic_val) %>%
mutate(ACCTRK = as.factor(ACCTRK)) %>%
select(`Railroad Successor`,`class 1`,ACCTRK,Accident_type,Category,traffic_value,Year) %>%
group_by(Category,Year) %>%
mutate(count=n(),final_traffic = sum(unique(traffic_value))) %>%
ungroup() %>%
group_by(Year) %>%
mutate(final_traffic = max(final_traffic)) %>%
mutate(rate=count/final_traffic) %>%
unique()
aaa = raw %>%
# filter(!is.na(TYPE_clean), !is.na(TotalDerail), TotalDerail >= 0) %>%
mutate(Accident_type = ifelse(TYPE_clean == "01", "Derailments",
ifelse(TYPE_clean %in% c("02","03","04","05","06","08"), "Collisions",
ifelse(TYPE_clean == "07", "Grade Crossing", "Other")))) %>%
mutate(Date = as.Date(as.character(Date),format = "%Y%m%d")) %>%
filter(TrainType %in% c("F"),
Accident_type %in% c("Derailments","Collisions"),
#`class 1`=="class1",
#`Railroad Successor` %in% c("BNSF","KCS","UP","CSX","NS","CNGT","CP(US)"),
ACCTRK %in% c(2,4),
Date <= "2022-12-31",
Date >= "2013-01-01") %>%
mutate(`Railroad Successor` = ifelse(`Railroad Successor` == "CNGT", "CN",
ifelse(`Railroad Successor` == "CP(US)", "CP", `Railroad Successor`))) %>%
mutate(traffic_name = paste(ifelse(`class 1`=="class1", `Railroad Successor`, "Non"),
"ClassI",
"Freight",
ifelse(ACCTRK%in%c(1,3),"Both_Mainline","Non_Mainline"),sep = "_")) %>%
select(`Railroad Successor`,`class 1`,ACCTRK,Accident_type,Category,traffic_name,Year) %>%
left_join(raw_traffic,by=c("traffic_name"="...1")) %>%
mutate(index = Year - 1996 + 8, traffic_value = 0)
num_vec = seq(1:nrow(aaa))
index_vec = as.vector(aaa %>% select(index))[[1]]
final = aaa
traffic_val = mapply(function(i, j) {
final[i, ncol(aaa)] = aaa[i, j][[1]]
}, i = num_vec, j = index_vec)
final =
final %>%
mutate(traffic_value = traffic_val) %>%
mutate(ACCTRK = as.factor(ACCTRK)) %>%
select(`Railroad Successor`,`class 1`,ACCTRK,Accident_type,Category,traffic_value,Year) %>%
group_by(Category,Year) %>%
mutate(count=n(),final_traffic = sum(unique(traffic_value))) %>%
ungroup() %>%
group_by(Year) %>%
mutate(final_traffic = max(final_traffic)) %>%
mutate(rate=count/final_traffic) %>%
unique()
aaa = raw %>%
# filter(!is.na(TYPE_clean), !is.na(TotalDerail), TotalDerail >= 0) %>%
mutate(Accident_type = ifelse(TYPE_clean == "01", "Derailments",
ifelse(TYPE_clean %in% c("02","03","04","05","06","08"), "Collisions",
ifelse(TYPE_clean == "07", "Grade Crossing", "Other")))) %>%
mutate(Date = as.Date(as.character(Date),format = "%Y%m%d")) %>%
filter(#TrainType %in% c("F"),
Accident_type %in% c("Derailments","Collisions"),
`class 1`=="class1",
`Railroad Successor` %in% c("BNSF","KCS","UP","CSX","NS","CNGT","CP(US)"),
ACCTRK %in% c(2,4),
Date <= "2022-12-31",
Date >= "2013-01-01") %>%
mutate(`Railroad Successor` = ifelse(`Railroad Successor` == "CNGT", "CN",
ifelse(`Railroad Successor` == "CP(US)", "CP", `Railroad Successor`))) %>%
mutate(traffic_name = paste(ifelse(`class 1`=="class1", `Railroad Successor`, "Non"),
"ClassI",
"Freight",
ifelse(ACCTRK%in%c(1,3),"Both_Mainline","Non_Mainline"),sep = "_")) %>%
select(`Railroad Successor`,`class 1`,ACCTRK,Accident_type,Category,traffic_name,Year) %>%
left_join(raw_traffic,by=c("traffic_name"="...1")) %>%
mutate(index = Year - 1996 + 8, traffic_value = 0)
num_vec = seq(1:nrow(aaa))
index_vec = as.vector(aaa %>% select(index))[[1]]
final = aaa
traffic_val = mapply(function(i, j) {
final[i, ncol(aaa)] = aaa[i, j][[1]]
}, i = num_vec, j = index_vec)
final =
final %>%
mutate(traffic_value = traffic_val) %>%
mutate(ACCTRK = as.factor(ACCTRK)) %>%
select(`Railroad Successor`,`class 1`,ACCTRK,Accident_type,Category,traffic_value,Year) %>%
group_by(Category,Year) %>%
mutate(count=n(),final_traffic = sum(unique(traffic_value))) %>%
ungroup() %>%
group_by(Year) %>%
mutate(final_traffic = max(final_traffic)) %>%
mutate(rate=count/final_traffic) %>%
unique()
runApp('C:/Users/liuxi/Desktop/Research/2023.03.22 (FRA 2023)/Main APP')
library(shiny); runApp('FRA_Visualizer.R')
runApp('FRA_Visualizer.R')
raw = read_csv("https://raw.githubusercontent.com/Xinhao-Liu/FRA_Visualizer/main/All_year_FRA_1996_2022_10.25.2023.csv")
View(raw)
raw %>%
filter(Year > 1996) %>%
filter(!is.na(TYPE_clean), !is.na(TotalDerail), TotalDerail >= 0) %>%
mutate(Accident_type = ifelse(TYPE_clean == "01", "Derailments",
ifelse(TYPE_clean %in% c("02","03","04","05","06","08"), "Collisions",
ifelse(TYPE_clean == "07", "Grade Crossing", "Other")))) %>%
mutate(Date = as.Date(as.character(Date),format = "%Y%m%d")) %>%
mutate(HIGHSPD = as.numeric(HIGHSPD)) %>%
filter(`class 1` %in% input$RRClass_type,
TrainType %in% input$Train_type,
Accident_type %in% input$accident_type,
ACCTRK %in% input$track_type,
Category %in% input$accident_cause,
Date <= input$date[2],
Date >= input$date[1],
TRKCLAS %in% input$track_class,
HIGHSPD >= input$speed[1],
HIGHSPD <= input$speed[2]) %>%
filter(if(length(input$RRClass_type) == 1 && input$RRClass_type == 'class1') {
`Railroad Successor` %in% input$ClassI_type
} else {
SUMS != "999"
})
runApp('FRA_Visualizer.R')
